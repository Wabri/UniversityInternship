(function () {
    'use strict';

    angular.module('revux').directive('selectYearMonth', selectYearMonth);

    function selectYearMonth() {

        var directive = {
            templateUrl: 'common/directives/selectYearMonth/selectYearMonth.directive.html',
            restrict: 'E',
            controller: controller,
            controllerAs: 'ctrl',
            bindToController: true,
            scope: {
                yearSelected: '=',
                monthSelected: '=',
                yearsBeforeCurrent: '=',
                yearsAfterCurrent: '=',
                disableSelect: '=',
                api: "=?"
            }
        };

        return directive;
    }

    /**
     * controller
     */
    function controller() {

        // bp
        var vm = this;
        vm.change= change;

        init();

        /**
         *
         */
        function init() {

            // definito api
            if (vm.api) {
                vm.api.isReady = function () {
                    return true;
                }
            }

            // i dati vanno qui
            vm.years = [];
            vm.months = [];

            // data in moment
            var eNow = new Date();

            // ANNO
            var eMoment = moment(eNow);

            // trasforma in negativo
            vm.yearsBeforeCurrent = vm.yearsBeforeCurrent * -1;

            // se non passato default
            if (!vm.yearSelected) {
                vm.yearSelected = {
                    "description": eMoment.format('YYYY')
                };
            }

            // per adattare la partenza
            eMoment = eMoment.add(vm.yearsBeforeCurrent, 'years');

            // cicla per anno
            for (var i = vm.yearsBeforeCurrent; i <= (0 + vm.yearsAfterCurrent); i++) {

                var appYears = {
                    "description": eMoment.format('YYYY')
                };

                // aumenta anno
                eMoment = eMoment.add(1, 'years');

                // nelle combo's
                vm.years.push(appYears);
            }

            // MESE
            var eMoment = moment(eNow);

            // se non passato default
            if (!vm.monthSelected) {
                vm.monthSelected = {
                    "id" : eMoment.format('MM'),
                    "description": eMoment.format('MMMM')
                };
            }

            var currentMonthNumber = (parseInt(eMoment.format("M")) - 1) * -1;

            // scala i mesi di differenza
            eMoment = eMoment.add(currentMonthNumber, 'months');

            for (var i = 1; i <= 12; i++) {

                var appMonths = {
                    "id": eMoment.format('MM'),
                    "description": eMoment.format('MMMM')
                };

                // aumenta anno
                eMoment = eMoment.add(1, 'months');

                // nelle combo's
                vm.months.push(appMonths);

            }

        }

        function change() {

            if (vm.api && vm.api.onChange) {
                vm.api.onChange({'monthSelected': vm.monthSelected, 'yearSelected': vm.yearSelected});
            }
        }

    };

}());
