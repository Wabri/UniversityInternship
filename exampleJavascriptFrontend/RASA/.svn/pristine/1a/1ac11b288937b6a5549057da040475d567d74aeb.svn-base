(function () {
"use strict";
angular.module('revux')
    .directive('topbar', function ($rootScope, $state, $stateParams, FunctionalityRolesService, Broadcaster, Events, NewsService) {

        /**
         * link
         * @param $scope
         * @param attrs
         */
        function link($scope, attrs) {

            //$scope.functionalityRoles = localStorageService.get('functionalityRoles');


            function build () {

                //$scope.FunctionalityRolesService = FunctionalityRolesService;
                $scope.SLIPS = FunctionalityRolesService.paymentsRole;
                $scope.MSGS = FunctionalityRolesService.messagesRole;

                // invoka il servizio
                //FunctionalityRolesService.setupFromFunctionalityRoles($scope);

                /* mb
                var _roles = localStorageService.get('roles');
                if (_roles) {
                    for (var key in $scope.functionalityRoles) {
                        $scope[key] = false;
                        $scope[key] = UtilsService.evaluate($scope.functionalityRoles[key], _roles);
                    }
                }
                */


            };

            function init() {
                build();
            };

            // parte da qui
            init();

            $scope.hasSidebar = (attrs.hasSidebar === 'true');
            /*
            $rootScope.$on('changeContract', function () {
                build();
            });
            */



            /***
             * EVENTI VARI
             */

            /**
             * logout
             */
            $scope.logoutTopBar = function () {

                $rootScope.$broadcast(Events.LOGOUT_TOPBAR);
            };

            /*
            //trap event to reset topbar, TODO: refactor this.
            $scope.$on(Events.RESET_TOPBAR, function () {




                for (var key in $scope.functionalityRoles) {
                    $scope[key] = false;
                }

            });
            */

            // ha nuova assegnazione diritti
            $rootScope.$on(Events.ROLES_ASSIGNED, function () {
                //console.log("ROLES_ASSIGNED di topbar")
                build();
            });
        }

        return {
            templateUrl: 'common/directives/topbar.html',
            restrict: 'E',
            replace: true,
            link: link
        };
    });
})();