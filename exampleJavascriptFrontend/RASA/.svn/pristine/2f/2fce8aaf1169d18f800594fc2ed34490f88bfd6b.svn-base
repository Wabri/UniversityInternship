(function () {
    'use strict';

    angular.module('revux')
        .directive('sessionExpiredModal', sessionExpiredModal);

    /***
     *
     * @returns {{templateUrl: string, restrict: string, controller: controller}}
     */
    function sessionExpiredModal() {

        var directive = {
            templateUrl: 'common/directives/sessionExpiredModal/sessionExpiredModal.directive.html',
            restrict: 'EA',
            controller: controller
        };

        return directive;
    }

    /**
     * controller ; il controller
     * @param $scope
     */
    function controller($scope, $window, $state, Events, SessionPollingService, PropertiesService, LoginService, StorageService, UtilsService) {

        //var vm = this;
        $scope.modalIsShowed = false;
        SessionPollingService.modalIsShowed = $scope.modalIsShowed;
        $scope.goToLogin = goToLogin;
        $scope.exit = exit;

        init();

        //////////////////////////

        function init() {


            $scope.$on(Events.SESSION_EXPIRED, function () {

                if (!$state.is('login.app') && !$scope.modalIsShowed) {

                    // logout comunque
                    return LoginService.logout().then(function () {

                        $scope.modalIsShowed = true;
                        SessionPollingService.modalIsShowed = $scope.modalIsShowed;
                        SessionPollingService.disableCheck = true;

                        // subito la cancellazione
                        StorageService.clearAll();

                        // chude le modali
                        UtilsService.closeAllModal(true);

                        // mostra la window
                        $("#sessionExpiredModal").modal('show');
                    });
                }
            });
        };

        function goToLogin() {

            $scope.modalIsShowed = false;
            $state.go('login.app', {}, {reload: true});

            $("#sessionExpiredModal").modal('hide');
        };

        function exit() {

            $scope.modalIsShowed = false;
            SessionPollingService.disableCheck = false;
            $window.location.href = PropertiesService.properties.logoutRedirectUrl;

        };


    };

}());
